name: goals CI/CD
on: [push, workflow_dispatch]
jobs:
    Build_and_Test:
        runs-on: ubuntu-latest

        services:
          postgres_db:
            image: postgres:16
            ports:
              - 5432:5432
            env:
              POSTGRES_USER: user5
              POSTGRES_PASSWORD: pass5
              POSTGRES_DB: postgres_db5
            options: >-
              --health-cmd="pg_isready -U user5"
              --health-interval=10s
              --health-timeout=5s
              --health-retries=5

        steps:
            - name: wait for postgresDB to start
              run: |
                until pg_isready -h localhost -p 5432 -U user5; do
                  echo "waiting for DB to start"
                  sleep 2
                done
                echo "database is ready for use"
            - name: checkout code
              uses: actions/checkout@v4
            - name: setup python on the VM
              uses: actions/setup-python@v5
              with:
                python-version: "3.13"
            - name: setup virtual environment
              run: |
                python3 -m venv venvgoalsapp
                source venvgoalsapp/bin/activate
                python3 -m pip install --upgrade pip
            - name: cache dependencies
              uses: actions/cache@v3
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
            - name: install dependencies
              run: |
                echo $(pwd)
                pip install -r ./Backend/requirements.txt  
            - name: run code
              env:
                DATABASE_URL: postgresql://user5:pass5@localhost:5432/postgres_db5
              run: |
                python3 ./Backend/app.py &
                pytest -v 
                





